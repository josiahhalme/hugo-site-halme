<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="ie=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=author content="map[name:Josiah Halme]">
<meta name=description content="Overview After looking into why certain URL&amp;rsquo;s weren&amp;rsquo;t working, I discovered static site hosting doesn&amp;rsquo;t play nicely with CloudFront and Origin Access Identities.
As a result I removed the OAI and made the bucket public. This simplifies it somewhat, and the content is all publically available regardless.
 S3 The update S3 resources,
resource &amp;#34;aws_s3_bucket&amp;#34; &amp;#34;web&amp;#34; { bucket = var.domain acl = &amp;#34;public-read&amp;#34; website { index_document = &amp;#34;index.html&amp;#34; error_document = &amp;#34;error.">
<meta name=keywords content>
<meta name=robots content="noodp">
<meta name=theme-color content="#252627">
<link rel=canonical href=https://halme.org/posts/2020/02/cloudfront-s3-and-oai/>
<title>
CloudFront, S3 and OAI :: Josiah Halme
</title>
<link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css>
<link rel=stylesheet href=https://halme.org/main.17863a81d979b637a02cd7632a4d86e9d80563ef460fd6af1a56962efcaa066b.css>
<link rel=apple-touch-icon sizes=180x180 href=https://halme.org/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://halme.org/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://halme.org/favicon-16x16.png>
<link rel=manifest href=https://halme.org/site.webmanifest>
<link rel=mask-icon href=https://halme.org/safari-pinned-tab.svg color>
<link rel="shortcut icon" href=https://halme.org/favicon.ico>
<meta name=msapplication-TileColor content>
<meta name=theme-color content>
<meta itemprop=name content="CloudFront, S3 and OAI">
<meta itemprop=description content="Overview After looking into why certain URL&rsquo;s weren&rsquo;t working, I discovered static site hosting doesn&rsquo;t play nicely with CloudFront and Origin Access Identities.
As a result I removed the OAI and made the bucket public. This simplifies it somewhat, and the content is all publically available regardless.
 S3 The update S3 resources,
resource &#34;aws_s3_bucket&#34; &#34;web&#34; { bucket = var.domain acl = &#34;public-read&#34; website { index_document = &#34;index.html&#34; error_document = &#34;error."><meta itemprop=datePublished content="2020-02-17T00:00:00+00:00">
<meta itemprop=dateModified content="2020-02-17T00:00:00+00:00">
<meta itemprop=wordCount content="293"><meta itemprop=image content="https://halme.org">
<meta itemprop=keywords content>
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://halme.org">
<meta name=twitter:title content="CloudFront, S3 and OAI">
<meta name=twitter:description content="Overview After looking into why certain URL&rsquo;s weren&rsquo;t working, I discovered static site hosting doesn&rsquo;t play nicely with CloudFront and Origin Access Identities.
As a result I removed the OAI and made the bucket public. This simplifies it somewhat, and the content is all publically available regardless.
 S3 The update S3 resources,
resource &#34;aws_s3_bucket&#34; &#34;web&#34; { bucket = var.domain acl = &#34;public-read&#34; website { index_document = &#34;index.html&#34; error_document = &#34;error.">
<meta property="article:published_time" content="2020-02-17 00:00:00 +0000 UTC">
</head>
<body>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=https://halme.org/ style=text-decoration:none>
<div class=logo>
<span class=logo__mark>></span>
<span class=logo__text>halme.org</span>
<span class=logo__cursor>
</span>
</div>
</a>
<span class=header__right>
</span>
</span>
</header>
<div class=content>
<main class=post>
<div class=post-info>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
2 minutes
</p>
</div>
<article>
<h1 class=post-title>
<a href=https://halme.org/posts/2020/02/cloudfront-s3-and-oai/>CloudFront, S3 and OAI</a>
</h1>
<div class=post-content>
<h1 id=overview>Overview</h1>
<p>After looking into why certain URL&rsquo;s weren&rsquo;t working, I discovered static site
hosting doesn&rsquo;t play nicely with CloudFront and Origin Access Identities.</p>
<p>As a result I removed the OAI and made the bucket public. This simplifies it
somewhat, and the content is all publically available regardless.</p>
<hr>
<h2 id=s3>S3</h2>
<p>The update S3 resources,</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_s3_bucket&#34; &#34;web&#34;</span> {
  bucket <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>domain</span>
  acl    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;public-read&#34;</span>

  <span style=color:#66d9ef>website</span> {
    index_document <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;index.html&#34;</span>
    error_document <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;error.html&#34;</span>
  }

}

<span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;aws_iam_policy_document&#34; &#34;s3_policy&#34;</span> {
  <span style=color:#66d9ef>statement</span> {
    sid       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;PublicReadGetObject&#34;</span>
    actions   <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;s3:GetObject&#34;</span>]
    resources <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;${aws_s3_bucket.web.arn}/*&#34;</span>]
    <span style=color:#66d9ef>principals</span> {
      type        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span>
      identifiers <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;*&#34;</span>]
    }
  }
}
</code></pre></div><hr>
<h2 id=cloudfront>CloudFront</h2>
<p>We update the CloudFront distribution to get rid of the Origin Access Identity
code.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_cloudfront_distribution&#34; &#34;s3_distribution&#34;</span> {
  <span style=color:#66d9ef>origin</span> {
    domain_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${var.domain}.s3-website-${var.region}.amazonaws.com&#34;</span>
    origin_id   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;S3Origin-${var.domain}&#34;</span>
    <span style=color:#66d9ef>custom_origin_config</span> {
      http_port                <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
      https_port               <span style=color:#f92672>=</span> <span style=color:#ae81ff>443</span>
      origin_keepalive_timeout <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>
      origin_protocol_policy   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http-only&#34;</span>
      origin_read_timeout      <span style=color:#f92672>=</span> <span style=color:#ae81ff>30</span>
      origin_ssl_protocols <span style=color:#f92672>=</span> [
        <span style=color:#e6db74>&#34;TLSv1&#34;</span>,
        <span style=color:#e6db74>&#34;TLSv1.1&#34;</span>,
        <span style=color:#e6db74>&#34;TLSv1.2&#34;</span>,
      ]
    }
  }

  enabled             <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
  is_ipv6_enabled     <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
  comment             <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${var.domain} distribution&#34;</span>
  default_root_object <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;index.html&#34;</span>

  aliases <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;${var.domain}&#34;, &#34;www.${var.domain}&#34;</span>]

  <span style=color:#66d9ef>default_cache_behavior</span> {
    allowed_methods  <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;GET&#34;, &#34;HEAD&#34;</span>]
    cached_methods   <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;GET&#34;, &#34;HEAD&#34;</span>]
    compress         <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
    target_origin_id <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;S3Origin-${var.domain}&#34;</span>

    <span style=color:#66d9ef>forwarded_values</span> {
      query_string <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>

      <span style=color:#66d9ef>cookies</span> {
        forward <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;none&#34;</span>
      }
    }

    viewer_protocol_policy <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;redirect-to-https&#34;</span>
    min_ttl                <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
    default_ttl            <span style=color:#f92672>=</span> <span style=color:#ae81ff>3600</span>
    max_ttl                <span style=color:#f92672>=</span> <span style=color:#ae81ff>86400</span>
  }

  price_class <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;PriceClass_All&#34;</span>

  <span style=color:#66d9ef>restrictions</span> {
    <span style=color:#66d9ef>geo_restriction</span> {
      restriction_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;none&#34;</span>
    }
  }

  tags <span style=color:#f92672>=</span> {
    Environment <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;production&#34;</span>
  }

  <span style=color:#66d9ef>viewer_certificate</span> {
    acm_certificate_arn      <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_acm_certificate</span>.<span style=color:#66d9ef>cert</span>.<span style=color:#66d9ef>arn</span>
    ssl_support_method       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sni-only&#34;</span>
    minimum_protocol_version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TLSv1.1_2016&#34;</span>
  }
}

<span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;cloudfront_domain_name&#34;</span> {
  value <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_cloudfront_distribution</span>.<span style=color:#66d9ef>s3_distribution</span>.<span style=color:#66d9ef>domain_name</span>
}
</code></pre></div><hr>
<h2 id=conclusion>Conclusion</h2>
<p>On initial investigation, it looks like you can do pretty rewrites with Lambda,
however this seemed like overkill. At a glance currently, perhaps using the S3
API endpoint for CloudFront may be the way to keep S3 buckets private and use
Origin Access Identities.</p>
</div>
</article>
<hr>
<div class=post-info>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
293 Words
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2020-02-17 00:00 +0000
</p>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h></span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button next">
<a href=https://halme.org/posts/2019/11/adding-cloudfront-and-acm-ssl/>
<span class=button__text>Adding CloudFront and ACM SSL</span>
<span class=button__icon>â†’</span>
</a>
</span>
</div>
</div>
</main>
</div>
<footer class=footer>
</footer>
</div>
<script type=text/javascript src=https://halme.org/bundle.min.599099f1f14b78b657d524b28e10e0c5098e7cd46e9c7aed73d577068a276c3ff1bb234cbf29cb313333e83cf411727b43157c91ce5b809e2ffc81664614608e.js integrity="sha512-WZCZ8fFLeLZX1SSyjhDgxQmOfNRunHrtc9V3BoonbD/xuyNMvynLMTMz6Dz0EXJ7QxV8kc5bgJ4v/IFmRhRgjg=="></script>
</body>
</html>