<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="ie=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=author content="map[name:Josiah Halme]">
<meta name=description content="Overview To use SSL on my blog, I need to create an Amazon CloudFront web distribution along with adding a SSL certificate with AWS Certificate Manager (ACM).
 ACM (AWS Certificate Manager) Create an Amazon ACM certificate and validate with the appropriate DNS records that are output. As CloudFront requires the certificate to be in us-east-1, we need to ensure the certificate is created in that region.
resource &amp;#34;aws_acm_certificate&amp;#34; &amp;#34;cert&amp;#34; { provider = aws.">
<meta name=keywords content>
<meta name=robots content="noodp">
<meta name=theme-color content="#252627">
<link rel=canonical href=https://halme.org/posts/2019/11/adding-cloudfront-and-acm-ssl/>
<title>
Adding CloudFront and ACM SSL :: Josiah Halme
</title>
<link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css>
<link rel=stylesheet href=https://halme.org/main.17863a81d979b637a02cd7632a4d86e9d80563ef460fd6af1a56962efcaa066b.css>
<link rel=apple-touch-icon sizes=180x180 href=https://halme.org/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://halme.org/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://halme.org/favicon-16x16.png>
<link rel=manifest href=https://halme.org/site.webmanifest>
<link rel=mask-icon href=https://halme.org/safari-pinned-tab.svg color>
<link rel="shortcut icon" href=https://halme.org/favicon.ico>
<meta name=msapplication-TileColor content>
<meta name=theme-color content>
<meta itemprop=name content="Adding CloudFront and ACM SSL">
<meta itemprop=description content="Overview To use SSL on my blog, I need to create an Amazon CloudFront web distribution along with adding a SSL certificate with AWS Certificate Manager (ACM).
 ACM (AWS Certificate Manager) Create an Amazon ACM certificate and validate with the appropriate DNS records that are output. As CloudFront requires the certificate to be in us-east-1, we need to ensure the certificate is created in that region.
resource &#34;aws_acm_certificate&#34; &#34;cert&#34; { provider = aws."><meta itemprop=datePublished content="2019-11-24T00:00:00+00:00">
<meta itemprop=dateModified content="2019-11-24T00:00:00+00:00">
<meta itemprop=wordCount content="486"><meta itemprop=image content="https://halme.org">
<meta itemprop=keywords content>
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://halme.org">
<meta name=twitter:title content="Adding CloudFront and ACM SSL">
<meta name=twitter:description content="Overview To use SSL on my blog, I need to create an Amazon CloudFront web distribution along with adding a SSL certificate with AWS Certificate Manager (ACM).
 ACM (AWS Certificate Manager) Create an Amazon ACM certificate and validate with the appropriate DNS records that are output. As CloudFront requires the certificate to be in us-east-1, we need to ensure the certificate is created in that region.
resource &#34;aws_acm_certificate&#34; &#34;cert&#34; { provider = aws.">
<meta property="article:published_time" content="2019-11-24 00:00:00 +0000 UTC">
</head>
<body>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=https://halme.org/ style=text-decoration:none>
<div class=logo>
<span class=logo__mark>></span>
<span class=logo__text>halme.org</span>
<span class=logo__cursor>
</span>
</div>
</a>
<span class=header__right>
</span>
</span>
</header>
<div class=content>
<main class=post>
<div class=post-info>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
3 minutes
</p>
</div>
<article>
<h1 class=post-title>
<a href=https://halme.org/posts/2019/11/adding-cloudfront-and-acm-ssl/>Adding CloudFront and ACM SSL</a>
</h1>
<div class=post-content>
<h1 id=overview>Overview</h1>
<p>To use SSL on my blog, I need to create an
<a href=https://aws.amazon.com/cloudfront/>Amazon CloudFront</a> web distribution along
with adding a SSL certificate with
<a href=https://aws.amazon.com/certificate-manager/>AWS Certificate Manager (ACM)</a>.</p>
<hr>
<h2 id=acm-aws-certificate-manager>ACM (AWS Certificate Manager)</h2>
<p>Create an Amazon ACM certificate and validate with the appropriate DNS records
that are output. As CloudFront requires the certificate to be in us-east-1, we
need to ensure the certificate is created in that region.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_acm_certificate&#34; &#34;cert&#34;</span> {
  provider                  <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws</span>.<span style=color:#66d9ef>east</span>
  domain_name               <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>domain</span>
  validation_method         <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;DNS&#34;</span>
  subject_alternative_names <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;www.${var.domain}&#34;</span>]

  tags <span style=color:#f92672>=</span> {
    Name        <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>domain</span>
    Environment <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;production&#34;</span>
  }

  <span style=color:#66d9ef>lifecycle</span> {
    create_before_destroy <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
  }
}

<span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;domain_name&#34;</span> {
  value <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_acm_certificate</span>.<span style=color:#66d9ef>cert</span>.<span style=color:#66d9ef>domain_name</span>
}

<span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;domain_validation_options&#34;</span> {
  value <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_acm_certificate</span>.<span style=color:#66d9ef>cert</span>.<span style=color:#66d9ef>domain_validation_options</span>
}
</code></pre></div><p>Query the status through the console or CLI</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>➜ aws acm describe-certificate
--certificate-arn arn:aws:acm:ap-southeast-2:1234567890:certificate/abcd1234-1234-1234-1234-123456abcdef
--query <span style=color:#e6db74>&#39;Certificate.DomainValidationOptions[*].{name:DomainName,status:ValidationStatus}&#39;</span>
--output table
-----------------------------------------
|          DescribeCertificate          |
+----------------+----------------------+
|      name      |       status         |
+----------------+----------------------+
|  halme.org     |  SUCCESS             |
|  www.halme.org |  PENDING_VALIDATION  |
+----------------+----------------------+
</code></pre></div><hr>
<h2 id=s3>S3</h2>
<p>We previously had our S3 bucket configured to host a static website directly,
so we&rsquo;ll need to update our configuration to make it private, allowing
CloudFront access only.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_s3_bucket&#34; &#34;web&#34;</span> {
  bucket <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>domain</span>
}

<span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;aws_iam_policy_document&#34; &#34;s3_policy&#34;</span> {
  <span style=color:#66d9ef>statement</span> {
    actions   <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;s3:GetObject&#34;</span>]
    resources <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;${aws_s3_bucket.web.arn}/*&#34;</span>]

    <span style=color:#66d9ef>principals</span> {
      type        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;AWS&#34;</span>
      identifiers <span style=color:#f92672>=</span> [<span style=color:#66d9ef>aws_cloudfront_origin_access_identity</span>.<span style=color:#66d9ef>origin_access_identity</span>.<span style=color:#66d9ef>iam_arn</span>]
    }
  }

  <span style=color:#66d9ef>statement</span> {
    actions   <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;s3:ListBucket&#34;</span>]
    resources <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;${aws_s3_bucket.web.arn}&#34;</span>]

    <span style=color:#66d9ef>principals</span> {
      type        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;AWS&#34;</span>
      identifiers <span style=color:#f92672>=</span> [<span style=color:#66d9ef>aws_cloudfront_origin_access_identity</span>.<span style=color:#66d9ef>origin_access_identity</span>.<span style=color:#66d9ef>iam_arn</span>]
    }
  }
}

<span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_s3_bucket_policy&#34; &#34;web&#34;</span> {
  bucket <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_s3_bucket</span>.<span style=color:#66d9ef>web</span>.<span style=color:#66d9ef>id</span>
  policy <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>aws_iam_policy_document</span>.<span style=color:#66d9ef>s3_policy</span>.<span style=color:#66d9ef>json</span>
}
</code></pre></div><hr>
<h2 id=cloudfront>CloudFront</h2>
<p>We need to create an <a href=https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/private-content-restricting-access-to-s3.html>Origin Access Identity</a></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_cloudfront_origin_access_identity&#34; &#34;origin_access_identity&#34;</span> {
  comment <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${var.domain} cloudfront&#34;</span>
}
</code></pre></div><p>We will then create a CloudFront distribution</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>locals</span> {
  s3_origin_id <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;myS3Origin&#34;</span>
}

<span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_cloudfront_distribution&#34; &#34;s3_distribution&#34;</span> {
  <span style=color:#66d9ef>origin</span> {
    domain_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_s3_bucket</span>.<span style=color:#66d9ef>web</span>.<span style=color:#66d9ef>bucket_regional_domain_name</span>
    origin_id   <span style=color:#f92672>=</span> <span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>s3_origin_id</span>

    <span style=color:#66d9ef>s3_origin_config</span> {
      origin_access_identity <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_cloudfront_origin_access_identity</span>.<span style=color:#66d9ef>origin_access_identity</span>.<span style=color:#66d9ef>cloudfront_access_identity_path</span>
    }
  }

  enabled             <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
  is_ipv6_enabled     <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
  comment             <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${var.domain} distribution&#34;</span>
  default_root_object <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;index.html&#34;</span>

  aliases <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;${var.domain}&#34;</span>]

  <span style=color:#66d9ef>default_cache_behavior</span> {
    allowed_methods  <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;DELETE&#34;, &#34;GET&#34;, &#34;HEAD&#34;, &#34;OPTIONS&#34;, &#34;PATCH&#34;, &#34;POST&#34;, &#34;PUT&#34;</span>]
    cached_methods   <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;GET&#34;, &#34;HEAD&#34;</span>]
    target_origin_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>s3_origin_id</span>

    <span style=color:#66d9ef>forwarded_values</span> {
      query_string <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>

      <span style=color:#66d9ef>cookies</span> {
        forward <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;none&#34;</span>
      }
    }

    viewer_protocol_policy <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;redirect-to-https&#34;</span>
    min_ttl                <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
    default_ttl            <span style=color:#f92672>=</span> <span style=color:#ae81ff>3600</span>
    max_ttl                <span style=color:#f92672>=</span> <span style=color:#ae81ff>86400</span>
  }

  price_class <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;PriceClass_200&#34;</span>

  <span style=color:#66d9ef>restrictions</span> {
    <span style=color:#66d9ef>geo_restriction</span> {
      restriction_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;whitelist&#34;</span>
      locations        <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;AU&#34;, &#34;NZ&#34;, &#34;US&#34;</span>]
    }
  }

  tags <span style=color:#f92672>=</span> {
    Environment <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;production&#34;</span>
  }

  <span style=color:#66d9ef>viewer_certificate</span> {
    acm_certificate_arn <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_acm_certificate</span>.<span style=color:#66d9ef>cert</span>.<span style=color:#66d9ef>arn</span>
    ssl_support_method  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sni-only&#34;</span>
  }
}

<span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;cloudfront_domain_name&#34;</span> {
  value <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_cloudfront_distribution</span>.<span style=color:#66d9ef>s3_distribution</span>.<span style=color:#66d9ef>domain_name</span>
}
</code></pre></div><p>Run the terraform plan and it should output you a CloudFront domain (eventually)</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>aws_cloudfront_distribution.s3_distribution: Still modifying... <span style=color:#f92672>[</span>id<span style=color:#f92672>=</span>ABCDEFGHIJKLM, 24m0s elapsed<span style=color:#f92672>]</span>
aws_cloudfront_distribution.s3_distribution: Still modifying... <span style=color:#f92672>[</span>id<span style=color:#f92672>=</span>ABCDEFGHIJKLM, 24m10s elapsed<span style=color:#f92672>]</span>
aws_cloudfront_distribution.s3_distribution: Still modifying... <span style=color:#f92672>[</span>id<span style=color:#f92672>=</span>ABCDEFGHIJKLM, 24m20s elapsed<span style=color:#f92672>]</span>
aws_cloudfront_distribution.s3_distribution: Still modifying... <span style=color:#f92672>[</span>id<span style=color:#f92672>=</span>ABCDEFGHIJKLM, 24m30s elapsed<span style=color:#f92672>]</span>
aws_cloudfront_distribution.s3_distribution: Modifications complete after 24m38s <span style=color:#f92672>[</span>id<span style=color:#f92672>=</span>ABCDEFGHIJKLM<span style=color:#f92672>]</span>

Apply complete! Resources: <span style=color:#ae81ff>1</span> added, <span style=color:#ae81ff>0</span> changed, <span style=color:#ae81ff>0</span> destroyed.

Outputs:

cloudfront_domain_name <span style=color:#f92672>=</span> example.cloudfront.net
</code></pre></div><hr>
<h2 id=conclusion>Conclusion</h2>
<p>Browse to the cloudfront URL and you should have your static website.
It&rsquo;s then a matter of updating your DNS to point to URL.</p>
<p>Next article will look at streamlining and documenting the pipeline for pushing
updates/articles.</p>
</div>
</article>
<hr>
<div class=post-info>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
486 Words
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2019-11-24 00:00 +0000
</p>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h></span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://halme.org/posts/2020/02/cloudfront-s3-and-oai/>
<span class=button__icon>←</span>
<span class=button__text>CloudFront, S3 and OAI</span>
</a>
</span>
<span class="button next">
<a href=https://halme.org/posts/2019/11/a-serverless-blog-with-hugo/>
<span class=button__text>A Serverless Blog with Hugo</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</main>
</div>
<footer class=footer>
</footer>
</div>
<script type=text/javascript src=https://halme.org/bundle.min.599099f1f14b78b657d524b28e10e0c5098e7cd46e9c7aed73d577068a276c3ff1bb234cbf29cb313333e83cf411727b43157c91ce5b809e2ffc81664614608e.js integrity="sha512-WZCZ8fFLeLZX1SSyjhDgxQmOfNRunHrtc9V3BoonbD/xuyNMvynLMTMz6Dz0EXJ7QxV8kc5bgJ4v/IFmRhRgjg=="></script>
</body>
</html>